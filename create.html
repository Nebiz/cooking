<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recipe Form</title>
  <link rel="icon" type="image/png" href="img/favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"
    integrity="sha256-WCzAhd2P6gRJF9Hv3oOOd+hFJi/QJbv+Azn4CGB8gfY=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="css/recipe.css">
  <script type="text/javascript" src="lib/purify.min.js"></script>
</head>

<body>
  <!-- 1. Navbar -->
  <nav class="navbar navbar-light">
    <div class="container mainContent">
      <!-- Logo and Title -->
      <a class="navbar-brand" href="index.html">
        <img src="img/logo.png" alt="Logo">
        <span class="navbar-text">Ben's Book</span>
      </a>
    </div>
  </nav>

  <div class="container mb-5 mainContent">
    <h1 id="pageTitle" class="fw-bold text-primary">Nouvelle Recette</h1><br>
    <form id="recipeForm" autocomplete="off">
      <input autocomplete="false" name="hidden" type="text" style="display:none;">

      <div class="form-floating mb-3">
        <input type="text" id="title" class="form-control" name="title" placeholder="Titre">
        <label for="title">Titre</label>
      </div>

      <div class="form-floating mb-3">
        <textarea id="author" class="form-control dynamic-textarea" name="author" placeholder="Auteur"></textarea>
        <label for="author">Auteurs</label>
      </div>

      <div class="form-floating mb-3">
        <textarea id="description" class="form-control dynamic-textarea" name="description"
          placeholder="Description"></textarea>
        <label for="description">Description</label>
      </div>

      <ul class="list-group list-group-horizontal d-flex">
        <div class="form-floating mb-3">
          <input type="text" id="prep_time" class="form-control" name="prep_time" placeholder="Temps de préparation">
          <label for="prep_time">Temps de préparation</label>
        </div>

        <div class="form-floating mb-3 ms-1">
          <input type="text" id="cook_time" class="form-control" name="cook_time" placeholder="Temps de cuisson">
          <label for="cook_time">Temps de cuisson</label>
        </div>
      </ul>

      <div class="form-floating mb-3">
        <input type="text" id="servings" class="form-control" name="servings" placeholder="Portions">
        <label for="servings">Portions</label>
      </div>

      <div class="form-floating mb-3">
        <ol id="ingredients" class="form-control dynamic-textarea ps-4 editable-list" name="ingredients"
          placeholder="Ingrédients" contenteditable="true" spellcheck="true">
          <li></li>
        </ol>
        <label for="ingredients">Ingrédients</label>
      </div>

      <div class="form-floating mb-3">
        <ol id="instructions" class="form-control dynamic-textarea ps-4 editable-list" name="instructions"
          placeholder="Instructions" contenteditable="true" spellcheck="true">
          <li></li>
        </ol>
        <label for="instructions">Instructions</label>
      </div>

      <div class="form-floating mb-3">
        <textarea id="tags" class="form-control dynamic-textarea" name="tags" placeholder="Tags"></textarea>
        <label for="tags">Tags</label>
      </div>

      <div class="form-floating mb-3">
        <input type="text" id="image_url" class="form-control" name="image_url" placeholder="Image URL">
        <label for="image_url">Lien de l'image</label>
      </div>

      <button id="submitBtn" type="submit" class="btn btn-primary">Créer</button>
    </form>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script src="js/server.js"></script>
  <script>
    $(document).ready(function () {
      setDynamicTextarea();
      setUndeletableLiElement();
      isUserModifyingRecipe();
      setFormButtonActions();
    });

    function setFormButtonActions() {
      $("#recipeForm").on("submit", function (event) {
        event.preventDefault();
        const recipeJSON = formToJSON();
        checkSetCookie(recipeJSON);
        sendRecipeToServer(recipeJSON);
      });
    }

    function isUserModifyingRecipe() {
      const urlParams = new URLSearchParams(window.location.search);
      let recipeGUID = urlParams.get("recipe");
      if (recipeGUID) {
        getAllRecipe(function (jsonObjects) {
          let selectedRecipe = jsonObjects.find(recipeData => recipeData.recipe.file_name === recipeGUID);
          if (!selectedRecipe) {
            alert("Bad recipe guid");
            return;
          }
          jsonToForm(selectedRecipe);
          $("#pageTitle").text("Modifier une recette");
          $("#submitBtn").text("Modifier");
        });
      }
    }

    // For modifying recipe, set selected recipe into form.
    function jsonToForm(jsonObj) {
      const { recipe } = jsonObj;
      $("#title").val(recipe.title);
      $("#author").val(recipe.author.join(" ")).trigger("input");
      $("#description").val(recipe.description).trigger("input");
      $("#prep_time").val(recipe.prep_time);
      $("#cook_time").val(recipe.cook_time);
      $("#servings").val(recipe.servings);
      $("#tags").val(recipe.tags.join(" ")).trigger("input");
      $("#image_url").val(recipe.image_url);

      // <ol> New logic
      $('ol.editable-list').empty(); // remove the coded <li>
      // Check if arrray is empty, if you, reinsert <li> element, so there's a count and can get the data correctly. TODO: maybe refactor
      if (!recipe.ingredients.length) {
        $("#ingredients").append($("<li>"));
      }
      if (!recipe.instructions.length) {
        $("#instructions").append($("<li>"));
      }
      $("#ingredients").append(recipe.ingredients.map(ingredient => $("<li>").text(ingredient.quantity ? `${ingredient.quantity} ${ingredient.scale} ${ingredient.name}` : ingredient))).trigger("input");
      $("#instructions").append(recipe.instructions.map(instruction => $("<li>").text(instruction))).trigger("input");
    }

    // Parse data from form into JSON obj.
    function formToJSON() {
      const recipeData = {
        recipe: {
          title: DOMPurify.sanitize($("#title").val()),
          author: DOMPurify.sanitize($("#author").val()).split(/\s+/).filter(item => item !== ""),
          description: DOMPurify.sanitize($("#description").val()),
          prep_time: DOMPurify.sanitize($("#prep_time").val()),
          cook_time: DOMPurify.sanitize($("#cook_time").val()),
          servings: DOMPurify.sanitize($("#servings").val()),
          ingredients: sanitizeJsonObjects($('#ingredients li').map(function () { return $(this).text(); }).get().filter(x => x)), // DOMPurify.sanitize($("#ingredients").val()).split("\n").filter(item => item !== ""),
          instructions: sanitizeJsonObjects($('#instructions li').map((_, element) => $(element).text()).get().filter(x => x)), // DOMPurify.sanitize($("#instructions").val()).split("\n").filter(item => item !== ""),
          tags: DOMPurify.sanitize($("#tags").val()).split(/\s+/).filter(item => item !== ""),
          image_url: DOMPurify.sanitize($("#image_url").val()),
        }
      };
      return recipeData;
    }

    function setDynamicTextarea() {
      const textareas = $(".dynamic-textarea");
      // Reset and set new height to adjust content dynamically
      textareas.on("input", function () {
        $(this).css('height', 'auto');
        $(this).css('height', `${this.scrollHeight}px`);
      });
      textareas.each(function () {
        this.setAttribute("rows", 1); // Force textarea to only 1 line of height when only 1 line of text
        this.style.overflow = "hidden"; // Hide scrollbar
      });
    }

    function setUndeletableLiElement() {
      $('ol.editable-list').on('keydown', function (event) {
        if (event.key === 'Backspace') {
          var selection = window.getSelection();
          if (selection.focusNode === $(this).find("li")[0] && selection.focusOffset === 0) {
            event.preventDefault();
          }
        }
      });
    }

    // Set auth cookie from form
    function checkSetCookie(formJSON) {
      let nonEmptyProp = Object.entries(formJSON.recipe).filter(([key, value]) => value && value.length);
      if (nonEmptyProp.length === 1) {
        const [key, value] = nonEmptyProp[0];
        const regex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
        if (key === "image_url" && value.match(regex)) { // match() replaced those: value.length === 36 && value[8] === "-"
          Cookies.set('recette.auth', nonEmptyProp[0][1]);
          alert("Cookie set! :)");
        }
      }
    }
  </script>
</body>

</html>